suppressMessages(library(Seurat))
suppressWarnings(library(SOAR))
suppressMessages(library("dplyr"))
#Input pathway gene list, you can construct with youself.
data(Genes_by_pathway_kegg)
#gene annotation files.
data(block_annotation)
#LD data
data(chrom_ld)
#1.start to run the wrapper functions for preprogress.
Pagwas<-scPagwas_main(Pagwas = NULL,
gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
add_eqtls="OnlyTSS",
block_annotation = block_annotation,
Single_data = system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
FilterSingleCell=TRUE,
Pathway_list=Genes_by_pathway_kegg,
chrom_ld = chrom_ld,
scPagwasSession="scPagwasSession")
##------ Wed Mar 23 18:43:17 2022 ------##
##------ Wed Mar 23 18:43:22 2022 ------##
##------ Wed Mar 23 18:44:15 2022 ------##
##------ Wed Mar 23 18:44:15 2022 ------##
##------ Wed Mar 23 18:44:16 2022 ------##
##------ Wed Mar 23 18:44:17 2022 ------##
Objects()
# 7th: link_pwpca_block function start!!
Pagwas <- link_pwpca_block(Pagwas)
#8th: Pagwas_perform_regression function start!!
Pagwas <- Pagwas_perform_regression(Pagwas, iters = 200,n.cores=1)
Objects()
Bootstrap_P_Barplot(Pagwas=Pagwas,
figurenames = NULL,
width = 5,
height = 7,
do_plot=T,
title = "Test scPagwas")
Objects()
Bootstrap_estimate_Plot(Pagwas=Pagwas,
figurenames = NULL,
width = 9,
height = 7,
do_plot=T)
suppressMessages(require("WGCNA"))
suppressMessages(require("patchwork"))
suppressMessages(require("tidygraph"))
suppressMessages(require("ggraph"))
suppressMessages(require("igraph"))
#check the objects
Objects()
plot_pathway_contribution_network(
mat_datExpr=pca_cell_df,
vec_pathwaycontribution=Pagwas$Pathway_block_heritability,
vec_pathways_highlight=names(sort(Pagwas$Pathway_block_heritability,decreasing = T)[1:5]),
n_max_pathways=20,
igraph_algorithm = "drl",
fontface_labels="bold.italic",
color_edge = "#9D9D9D",
fontSize_label_lg=4,
fontSize_legend_lg=4,
fontSize_legend_xlg=4,
edge_thickness = 1,
do_plot=T
)
#check the objects
Objects()
Pagwas <- link_scCell_pwpca_block(Pagwas)
Pagwas <- scPagwas_perform_score(Pagwas)
#check the objects in Pagwas,if you don't need rerun, remove some objects
names(Pagwas)
Pagwas$
}}}
library(scPagwas)
suppressMessages(library(Seurat))
suppressWarnings(library(SOAR))
suppressMessages(library("dplyr"))
#Input pathway gene list, you can construct with youself.
data(Genes_by_pathway_kegg)
#gene annotation files.
data(block_annotation)
#LD data
data(chrom_ld)
#1.start to run the wrapper functions for preprogress.
Pagwas<-scPagwas_main(Pagwas = NULL,
gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
add_eqtls="OnlyTSS",
block_annotation = block_annotation,
Single_data = system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
FilterSingleCell=F,
Pathway_list=Genes_by_pathway_kegg,
chrom_ld = chrom_ld,
scPagwasSession="scPagwasSession")
##------ Wed Mar 23 19:10:15 2022 ------##
##------ Wed Mar 23 19:10:16 2022 ------##
##------ Wed Mar 23 19:11:11 2022 ------##
##------ Wed Mar 23 19:11:11 2022 ------##
##------ Wed Mar 23 19:11:11 2022 ------##
##------ Wed Mar 23 19:11:12 2022 ------##
Pagwas <- Single_data_input(Pagwas=NULL,
#nfeatures =nfeatures,
Single_data=severe_all,
#FilterSingleCell=FilterSingleCell,
Pathway_list=Genes_by_pathway_kegg
#min.lib.size = min.lib.size,
#min.reads =min.reads,
)
Objects()
# 7th: link_pwpca_block function start!!
Pagwas <- link_pwpca_block(Pagwas)
#8th: Pagwas_perform_regression function start!!
Pagwas <- Pagwas_perform_regression(Pagwas, iters = 200,n.cores=1)
Objects()
Bootstrap_P_Barplot(Pagwas=Pagwas,
figurenames = NULL,
width = 5,
height = 7,
do_plot=T,
title = "Test scPagwas")
#check the objects
Objects()
Pagwas <- link_scCell_pwpca_block(Pagwas)
Pagwas <- scPagwas_perform_score(Pagwas)
#check the objects in Pagwas,if you don't need rerun, remove some objects
names(Pagwas)
#Pagwas$
?big_copy()
?write_table
??write_table
gc()
devtools::install_github("dengchunyu/scPagwas")
renv::init()
renv::snapshot()
devtools::document()
usethis::use_version()
library(scPagwas)
library(scPagwas)
suppressMessages(library(Seurat))
suppressWarnings(library(SOAR))
suppressMessages(library("dplyr"))
#Input pathway gene list, you can construct with youself.
data(Genes_by_pathway_kegg)
#gene annotation files.
data(block_annotation)
#LD data
data(chrom_ld)
#1.start to run the wrapper functions for preprogress.
Pagwas<-scPagwas_main(Pagwas = NULL,
gwas_data =system.file("extdata", "GWAS_summ_example.txt", package = "scPagwas"),
add_eqtls="OnlyTSS",
block_annotation = block_annotation,
Single_data = system.file("extdata", "scRNAexample.rds", package = "scPagwas"),
FilterSingleCell=F,
Pathway_list=Genes_by_pathway_kegg,
chrom_ld = chrom_ld,
scPagwasSession="scPagwasSession")
##------ Thu Mar 24 09:11:10 2022 ------##
##------ Thu Mar 24 09:11:14 2022 ------##
##------ Thu Mar 24 09:11:27 2022 ------##
##------ Thu Mar 24 09:11:27 2022 ------##
##------ Thu Mar 24 09:11:28 2022 ------##
##------ Thu Mar 24 09:11:29 2022 ------##
Objects()
# 7th: link_pwpca_block function start!!
Pagwas <- link_pwpca_block(Pagwas,scPagwasSession="scPagwasSession")
#8th: Pagwas_perform_regression function start!!
Pagwas <- Pagwas_perform_regression(Pagwas,
iters = 200,
n.cores=1,
scPagwasSession="scPagwasSession")
Objects()
Bootstrap_P_Barplot(Pagwas=Pagwas,
figurenames = NULL,
width = 5,
height = 7,
do_plot=T,
title = "Test scPagwas")
Objects()
Bootstrap_estimate_Plot(Pagwas=Pagwas,
figurenames = NULL,
width = 9,
height = 7,
do_plot=T)
suppressMessages(require("WGCNA"))
suppressMessages(require("patchwork"))
suppressMessages(require("tidygraph"))
suppressMessages(require("ggraph"))
suppressMessages(require("igraph"))
#check the objects
Objects()
Sys.setenv(R_LOCAL_CACHE="scPagwasSession")
plot_pathway_contribution_network(
mat_datExpr=pca_cell_df,
vec_pathwaycontribution=Pagwas$Pathway_block_heritability,
vec_pathways_highlight=names(sort(Pagwas$Pathway_block_heritability,decreasing = T)[1:5]),
n_max_pathways=20,
igraph_algorithm = "drl",
fontface_labels="bold.italic",
color_edge = "#9D9D9D",
fontSize_label_lg=4,
fontSize_legend_lg=4,
fontSize_legend_xlg=4,
edge_thickness = 1,
do_plot=T
)
#check the objects
#Objects()
Pagwas <- link_scCell_pwpca_block(Pagwas,scPagwasSession="scPagwasSession")
Pagwas <- scPagwas_perform_score(Pagwas,scPagwasSession="scPagwasSession")
#check the objects in Pagwas,if you don't need rerun, remove some objects
#' scPagwas_perform_score
#' @description Get the scPagwas score for each cells
#' @param Pagwas Pagwas data list
#' @param n.cores cores
#' @param remove_outlier Whether to remove the outlier for scPagwas score.
#' @param scPagwasSession "scPagwasSession"
#' @return
#' @export
#'
#' @examples
#' library(scPagwas)
#' scPagwas_perform_score(Pagwas)
scPagwas_perform_score <- function(Pagwas,
n.cores = 1,
remove_outlier=TRUE,
scPagwasSession="scPagwasSession") {
Sys.setenv(R_LOCAL_CACHE=scPagwasSession)
if (is.null(SC_Pathway_ld_gwas_data)) {
stop("data has not been precomputed, returning without results")
# return(Pagwas)
}
# fit model
Pathway_names <- names(SC_Pathway_ld_gwas_data)
message("Run regression for ", length(Pathway_names), " pathways")
pb <- txtProgressBar(style = 3)
Pathway_sclm_results <- lapply(Pathway_names, function(Pathway) {
Pathway_block <- SC_Pathway_ld_gwas_data[[Pathway]]
noise_per_snp <- Pathway_block$snps$se**2
if (!is.null(Pathway_block$x)) {
if (nrow(Pathway_block$x) > 2) {
na_elements <- is.na(Pathway_block$y) | apply(Pathway_block$x, 1, function(x) {
any(is.na(x))
}) | is.na(noise_per_snp)
x <-as(Pathway_block$x, "matrix")
rownames(x) <- Pathway_block$snps$rsid
results <- scParameter_regression(Pagwas_x = x[!na_elements, ], Pagwas_y = Pathway_block$y[!na_elements], noise_per_snp = noise_per_snp[!na_elements], n.cores = n.cores)
results[is.na(results)] <- 0
}else{
return(NULL)
}
setTxtProgressBar(pb, which(Pathway_names == Pathway) / length(Pathway_names))
return(results)
} else {
return(NULL)
}
})
close(pb)
names(Pathway_sclm_results) <- Pathway_names
Pathway_sclm_results <- Pathway_sclm_results[!sapply(Pathway_sclm_results, is.null)]
Pathway_names <- names(Pathway_sclm_results)
Pathway_sclm_results <- as.data.frame(Pathway_sclm_results)
Pathway_sclm_results<-as(data.matrix(Pathway_sclm_results), "dgCMatrix")
#pca_scCell_mat<-as(pca_scCell_mat[Pathway_names, ],"dgCMatrix")
data_mat<-as(data_mat,"dgCMatrix")
pathway_expr <- lapply(Pathway_names, function(pa) {
a <- intersect(Pagwas$Pathway_list[[pa]], rownames(data_mat))
if (length(a) == 0) {
return(rep(0, ncol(data_mat)))
} else if (length(a) == 1) {
return(data_mat[intersect(a, rownames(data_mat)), ])
} else {
b <- apply(data_mat[intersect(a, rownames(data_mat)), ], 2, mean)
return(b)
}
})
#rm(data_mat)
pathway_expr <- as.data.frame(pathway_expr)
colnames(pathway_expr) <- Pathway_names
pathway_expr <- as(data.matrix(pathway_expr), "dgCMatrix")
pa_exp_mat <- as(t(as(pca_scCell_mat[Pathway_names, ],"matrix")), "dgCMatrix") * pathway_expr
scPagwas_mat <- Pathway_sclm_results * pa_exp_mat
rm(pa_exp_mat)
rm(pathway_expr)
scs <- rowSums(scPagwas_mat)
rm(scPagwas_mat)
SOAR::Store(Pathway_sclm_results)
scs <- sign(scs) * log10(abs(scs) + 0.0001)
df <- data.frame(cellid = colnames(pca_scCell_mat), scPagwas_score = scs)
rownames(df) <- df$cellid
rm(scs)
#rm(pca_scCell_mat)
gc()
if (remove_outlier) {
Pagwas$scPagwas_score <- scPagwas_score_filter(scPagwas_score = df$scPagwas_score)
}
names(Pagwas$scPagwas_score)<-df$cellid
Pagwas$gene_heritability_correlation<-scGet_gene_heritability_correlation(
scPagwas_score=Pagwas$scPagwas_score,
data_mat=raw_data_mat[,names(Pagwas$scPagwas_score)])
rm(df)
return(Pagwas)
}
#' scParameter_regression
#' @description Find parameter estimates for the data.
#' @param Pagwas_x x parameter for lm
#' @param Pagwas_y y parameter for lm
#' @param noise_per_snp noise
#' @param n.cores cores
#'
#' @return
scParameter_regression <- function(Pagwas_x, Pagwas_y, noise_per_snp, n.cores = 1) {
x_df <- bigstatsr::as_FBM(Pagwas_x, type = "double")
liear_m <- bigstatsr::big_univLinReg(
X = x_df,
y.train = Pagwas_y,
covar.train = bigstatsr::covar_from_df(data.frame(offset(noise_per_snp))),
ncores = n.cores
)
return(liear_m$estim)
}
#' scPagwas_score_filter
#' @description filter the cPagwas_score for outliers.
#' @param scPagwas_score (data.frame)
#'
#' @return
scPagwas_score_filter <- function(scPagwas_score) {
#scPagwas_score <- scPagwas_score$scPagwas_score
# remove the NAN!
if(sum(is.nan(scPagwas_score))>0){
scPagwas_score[is.nan(scPagwas_score)]<-0
}
# remove the inf values!
if (Inf %in% scPagwas_score) {
scPagwas_score[which(scPagwas_score == Inf)] <- max(scPagwas_score[-which(scPagwas_score == Inf)],na.rm=TRUE)
}
if (-Inf %in% scPagwas_score) {
scPagwas_score[which(scPagwas_score == -Inf)] <- min(scPagwas_score[-which(scPagwas_score == -Inf)],na.rm=TRUE)
}
lower_bound <- quantile(scPagwas_score, 0.01,na.rm=TRUE)
upper_bound <- quantile(scPagwas_score, 0.99,na.rm=TRUE)
lower_ind <- which(scPagwas_score < lower_bound)
upper_ind <- which(scPagwas_score > upper_bound)
scPagwas_score[lower_ind] <- lower_bound
scPagwas_score[upper_ind] <- upper_bound
return(scPagwas_score)
}
#' scGet_gene_heritability_contributions
#'
#' @param scPagwas_score result of scPagwas
#' @param data_mat the data matrix from single cell data
#'
#' @return
#' @examples
#' Single_data<-readRDS("E:/RPakage/scPagwas/inst/extdata/scRNAexample.rds")
#' Pagwas$sparse_cor<-scGet_gene_heritability_contributions(
#' scPagwas_score=Pagwas$scPagwas_score,
#' data_mat=Seurat::GetAssayData(object = Single_data[,names(Pagwas$scPagwas_score)], slot = "data"))
scGet_gene_heritability_correlation <- function(scPagwas_score,data_mat){
if(all(names(scPagwas_score)==colnames(data_mat))){
scPagwas_score<-data.matrix(scPagwas_score)
sparse_cor<-corSparse(X=t(as(data_mat,"matrix")), Y=scPagwas_score)
}else{
data_mat<-data_mat[,names(scPagwas_score)]
scPagwas_score<-data.matrix(scPagwas_score)
sparse_cor<-corSparse(X=t(as(data_mat,"matrix")), Y=scPagwas_score)
}
return(sparse_cor)
}
Pagwas <- scPagwas_perform_score(Pagwas,scPagwasSession="scPagwasSession")
devtools::load_all(".")
Pagwas <- scPagwas_perform_score(Pagwas,scPagwasSession="scPagwasSession")
require("RColorBrewer")
require("Seurat")
require("SeuratObject")
require("ggsci")
#check the objects
Objects()
scRNAexample<-readRDS(system.file("extdata", "scRNAexample.rds", package = "scPagwas"))
scPagwas_Visualization(scPagwas_score = Pagwas$scPagwas_score,
Single_data = scRNAexample,
Reduction = TRUE,
assay = "SCT",
cellpercent = 0.1,
filename = NULL,
FigureType = "tsne",
width = 7,
height = 7,
lowColor = "#FFBC80", highColor = "#FC4F4F",
size = 1,
title = "scPagwas_score",
do_plot = T)
library("RColorBrewer")
library("ggplot2")
scPagwas_score <- Pagwas$scPagwas_score[intersect(colnames(scRNAexample),names(Pagwas$scPagwas_score))]
scRNAexample$scPagwas_score <- scPagwas_score
thre <- sort(scRNAexample$scPagwas_score, decreasing = T)[ncol(scRNAexample) * 0.1]
scRNAexample$positiveCells<-rep(0,ncol(scRNAexample))
scRNAexample$positiveCells[scRNAexample$scPagwas_score>=thre]<-1
plot_bar_positie_nagtive(seurat_obj=scRNAexample,
var_ident="positiveCells",
var_group="anno",
vec_group_colors=NULL,
f_color=colorRampPalette(brewer.pal(n=10, name="RdYlBu")),
do_plot = T)
plot_bar_positie_nagtive(seurat_obj=scRNAexample,
var_ident="anno",
var_group="positiveCells",
vec_group_colors=c("#E8D0B3","#7EB5A6"),
#f_color=colorRampPalette(brewer.pal(n=11, name="RdYlBu")),
do_plot = T)
top5genes<-rownames(Pagwas$gene_heritability_correlation)[order(Pagwas$gene_heritability_correlation,decreasing = T)[1:5]]
plot_vln_Corgenes(seurat_obj=scRNAexample,
assay="RNA", slot="data",
var_group="anno",# 细胞cluster注释列
vec_features=top5genes,
vec_group_colors= pal_d3(alpha =0.5)(10),
do_plot = T
)
Pagwas <- scPagwas_perform_regression(Pagwas)
Pagwas <- scPagwas_perform_regression(Pagwas,scPagwasSession="scPagwasSession")
i<-1
part_vector <- xy2vector(SC_Pathway_ld_gwas_data[
sample(seq_len(length(SC_Pathway_ld_gwas_data)),
floor(length(SC_Pathway_ld_gwas_data) * 0.25))
])
part_vector
part_vector$x
scBoot_evaluate <- function(Pagwas, bootstrap_iters = bootstrap_iters, n.cores = n.cores) {
# run things in parallel if user specified
scBoot_evaluate <- papply(1:bootstrap_iters, function(i) {
part_vector <- xy2vector(SC_Pathway_ld_gwas_data[
sample(seq_len(length(SC_Pathway_ld_gwas_data)),
floor(length(SC_Pathway_ld_gwas_data) * 0.25))
])
part_vector$x<-as(part_vector$x,"matrix")
boot_results <- scParameter_regression(part_vector)
return(boot_results$parameters)
}, n.cores = n.cores)
#SOAR::Store(Pathway_ld_gwas_data)
df <- as.data.frame(sapply(scBoot_evaluate, function(boot) {
boot
}))
rm(scBoot_evaluate)
Pagwas$scbootstrap_results <- Get_bootresults_df(
value_collection = df,
annotations = names(Pagwas$sclm_results$parameters),
model_estimates = Pagwas$sclm_results$parameters
)
return(Pagwas)
}
Pagwas <- scPagwas_perform_regression(Pagwas,scPagwasSession="scPagwasSession")
scPagwas_perform_regression <- function(Pagwas, n.cores = 1,scPagwasSession="scPagwasSession") {
Sys.setenv(R_LOCAL_CACHE=scPagwasSession)
if (is.null(SC_Pathway_ld_gwas_data)) {
warning("data has not been precomputed, returning without results")
return(Pagwas)
}
message("Start inference")
# fit model
vectorized_Pagwas_data <- xy2vector(SC_Pathway_ld_gwas_data)
sclm_results <- scParameter_regression(Pagwas_x=as(vectorized_Pagwas_data[[2]],"matrix"),
Pagwas_y=vectorized_Pagwas_data[[1]],
noise_per_snp=vectorized_Pagwas_data[[3]],
n.cores = 1)
sclm_results[is.na(sclm_results)] <- 0
names(sclm_results)<-colnames(vectorized_Pagwas_data[[2]])
rm(vectorized_Pagwas_data)
Pagwas$sclm_results <- sclm_results
rm(sclm_results)
Pagwas$scPathway_heritability_contributions <-
scGet_Pathway_heritability_contributions(
Pagwas$ff.pca_scCell_mat,
Pagwas$sclm_results
)
return(Pagwas)
}
Pagwas <- scPagwas_perform_regression(Pagwas,scPagwasSession="scPagwasSession")
class(pca_scCell_mat )
scPagwas_perform_regression <- function(Pagwas, n.cores = 1,scPagwasSession="scPagwasSession") {
Sys.setenv(R_LOCAL_CACHE=scPagwasSession)
if (is.null(SC_Pathway_ld_gwas_data)) {
warning("data has not been precomputed, returning without results")
return(Pagwas)
}
message("Start inference")
# fit model
vectorized_Pagwas_data <- xy2vector(SC_Pathway_ld_gwas_data)
sclm_results <- scParameter_regression(Pagwas_x=as(vectorized_Pagwas_data[[2]],"matrix"),
Pagwas_y=vectorized_Pagwas_data[[1]],
noise_per_snp=vectorized_Pagwas_data[[3]],
n.cores = 1)
sclm_results[is.na(sclm_results)] <- 0
names(sclm_results)<-colnames(vectorized_Pagwas_data[[2]])
rm(vectorized_Pagwas_data)
Pagwas$sclm_results <- sclm_results
rm(sclm_results)
Pagwas$scPathway_heritability_contributions <-
scGet_Pathway_heritability_contributions(
pca_scCell_mat,
Pagwas$sclm_results
)
return(Pagwas)
}
#' scBoot_evaluate
#' @description Bootstrap to evaluate for confidence intervals.
#' @param Pagwas Pagwas object
#' @param bootstrap_iters number of bootstrap iterations to run
#' @param n.co
Pagwas <- scPagwas_perform_regression(Pagwas,scPagwasSession="scPagwasSession")
devtools::document()
devtools::document()
options(download.file.method="libcurl", url.method="libcurl")
pkgdown::build_site()
